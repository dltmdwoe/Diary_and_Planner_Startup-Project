#include <stdio.h>
#include <stdlib.h>
#include <string.h> 
#include <stdbool.h>
#include <windows.h>
#define PASSWORD_LENGTH 5
#define MAX_LENGTH 1000 
#define MAX_DAYS_IN_MONTH 31
#define MAX_MONTHS_IN_YEAR 12
char password[MAX_LENGTH];

void GotoXY(int x, int y) {
    COORD Pos;
    Pos.X = x;
    Pos.Y = y;
    SetConsoleCursorPosition(GetStdHandle(STD_OUTPUT_HANDLE), Pos);
}

typedef struct {
    char content[MAX_LENGTH];
} Diary;

typedef struct {
    char content[MAX_LENGTH];
} Planner;

Diary diaries[MAX_DAYS_IN_MONTH][MAX_MONTHS_IN_YEAR];
Planner planners[MAX_DAYS_IN_MONTH][MAX_MONTHS_IN_YEAR];

void printCalendar(int year, int month) {
    int daysInMonth, i, j, dayOfWeek = 0;
    int daysPerMonth[MAX_MONTHS_IN_YEAR] = {31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31};

    if ((year % 4 == 0 && year % 100 != 0) || year % 400 == 0) {
        daysPerMonth[1] = 29;
    }
    daysInMonth = daysPerMonth[month - 1];
    printf("Sun Mon Tue Wed Thu Fri Sat\n");

    for (i = 1; i < month; i++) {
        dayOfWeek += daysPerMonth[i - 1];
    }
    dayOfWeek %= 7;
    for (i = 0; i < dayOfWeek; i++) {
        printf("    ");
    }
    for (i = 1; i <= daysInMonth; i++) {
        printf("%3d ", i);
        dayOfWeek++;
        if (dayOfWeek % 7 == 0) {
            printf("\n");
        }
    }
    printf("\n");
}

void writeDiaryToFile(int day, int month) {
    char filename[MAX_LENGTH];
    sprintf(filename, "%d-%d-diary.txt", month, day);

    FILE *file = fopen(filename, "w");
    if (file == NULL) {
        printf("파일을 열 수 없습니다.\n");
        return;
    }

    fprintf(file, "%s", diaries[day - 1][month - 1].content);
    fclose(file);
    printf("%d월 %d일의 일기가 파일에 저장되었습니다.\n", month, day);
}

void writePlannerToFile(int day, int month) {
    char filename[MAX_LENGTH];
    sprintf(filename, "%d-%d-planner.txt", month, day);

    FILE *file = fopen(filename, "w");
    if (file == NULL) {
        printf("파일을 열 수 없습니다.\n");
        return;
    }

    fprintf(file, "%s", planners[day - 1][month - 1].content);
    fclose(file);
    printf("%d월 %d일의 플래너가 파일에 저장되었습니다.\n", month, day);
}

void viewDiaryFromFile(int day, int month) {
    char filename[MAX_LENGTH];
    sprintf(filename, "%d-%d-diary.txt", month, day);

    FILE *file = fopen(filename, "r");
    if (file == NULL) {
        printf("%d월 %d일에 일기가 없습니다.\n", month, day);
        return;
    }

    char buffer[MAX_LENGTH];
    while (fgets(buffer, MAX_LENGTH, file) != NULL) {
        printf("%s", buffer);
    }
    fclose(file);
}

void viewPlannerFromFile(int day, int month) {
    char filename[MAX_LENGTH];
    sprintf(filename, "%d-%d-planner.txt", month, day);

    FILE *file = fopen(filename, "r");
    if (file == NULL) {
        printf("%d월 %d일에 플래너가 없습니다.\n", month, day);
        return;
    }

    char buffer[MAX_LENGTH];
    while (fgets(buffer, MAX_LENGTH, file) != NULL) {
        printf("%s", buffer);
    }
    fclose(file);
}

void writeDiary(int day, int month) {
    printf("%d월 %d일의 일기를 쓰세요 (최대 %d글자):\n", month, day, MAX_LENGTH);
    getchar();
    fgets(diaries[day - 1][month - 1].content, MAX_LENGTH, stdin);
    writeDiaryToFile(day, month);
    printf("%d월 %d일의 일기가 저장되었습니다.\n", month, day);
}

void writePlanner(int day, int month) {
    printf("%d월 %d일의 플래너를 쓰세요 (최대 %d글자):\n", month, day, MAX_LENGTH);
    getchar();
    fgets(planners[day - 1][month - 1].content, MAX_LENGTH, stdin);
    writePlannerToFile(day, month);
    printf("%d월 %d일의 플래너가 저장되었습니다.\n", month, day);
}

void modifyDiary(int day, int month) {
    char filename[MAX_LENGTH];
    sprintf(filename, "%d-%d-diary.txt", month, day);

    FILE *file = fopen(filename, "r");
    if (file == NULL) {
        printf("%d월 %d일에 일기가 없습니다.\n", month, day);
        return;
    }

    fclose(file);

    printf("수정할 내용을 입력하세요 (최대 %d글자):\n", MAX_LENGTH);
    getchar();
    fgets(diaries[day - 1][month - 1].content, MAX_LENGTH, stdin);

    writeDiaryToFile(day, month);

    printf("%d월 %d일의 일기가 수정되었습니다.\n", month, day);
}

void modifyPlanner(int day, int month) {
    char filename[MAX_LENGTH];
    sprintf(filename, "%d-%d-planner.txt", month, day);

    FILE *file = fopen(filename, "r");
    if (file == NULL) {
        printf("%d월 %d일에 플래너가 없습니다.\n", month, day);
        return;
    }

    fclose(file);

    printf("수정할 내용을 입력하세요 (최대 %d글자):\n", MAX_LENGTH);
    getchar();
    fgets(planners[day - 1][month - 1].content, MAX_LENGTH, stdin);

    writePlannerToFile(day, month);

    printf("%d월 %d일의 플래너가 수정되었습니다.\n", month, day);
}

void deleteDiary(int day, int month) {
    char filename[MAX_LENGTH];
    sprintf(filename, "%d-%d-diary.txt", month, day);

    FILE *file = fopen(filename, "r");
    if (file == NULL) {
        printf("%d월 %d일에 일기가 없습니다.\n", month, day);
        return;
    }

    fclose(file);

    if (remove(filename) == 0) {
        printf("%d월 %d일의 일기가 삭제되었습니다.\n", month, day);
    } else {
        printf("삭제 실패: 파일을 찾을 수 없습니다.\n");
    }
}

void deletePlanner(int day, int month) {
    char filename[MAX_LENGTH];
    sprintf(filename, "%d-%d-planner.txt", month, day);

    FILE *file = fopen(filename, "r");
    if (file == NULL) {
        printf("%d월 %d일에 플래너가 없습니다.\n", month, day);
        return;
    }

    fclose(file);

    if (remove(filename) == 0) {
        printf("%d월 %d일의 플래너가 삭제되었습니다.\n", month, day);
    } else {
        printf("삭제 실패: 파일을 찾을 수 없습니다.\n");
    }
}

void viewDiary(int day, int month) {
    char choice;
    viewDiaryFromFile(day, month);

    printf("수정 또는 삭제하시겠습니까? (m/d/n): ");
    scanf(" %c", &choice);

    switch (choice) {
        case 'm':
        case 'M':
            modifyDiary(day, month);
            break;
        case 'd':
        case 'D':
            deleteDiary(day, month);
            break;
        default:
            break;
    }
}

void viewPlanner(int day, int month) {
    char choice;
    viewPlannerFromFile(day, month);
    printf("수정 또는 삭제하시겠습니까? (m/d/n): ");
    scanf(" %c", &choice);

    switch (choice) {
        case 'm':
        case 'M':
            modifyPlanner(day, month);
            break;
        case 'd':
        case 'D':
            deletePlanner(day, month);
            break;
        default:
            break;
    }
}

bool checkPassword(const char *inputPassword) {
    char password[PASSWORD_LENGTH];
    FILE *file = fopen("password.txt", "r");
    if (file == NULL) {
        printf("파일을 열 수 없습니다.\n");
        return false;
    }

    fgets(password, PASSWORD_LENGTH, file);
    fclose(file);

    if (strcmp(inputPassword, password) == 0) {
        return true; // 비밀번호 일치
    } else {
        return false; // 비밀번호 불일치
    }
}

void setPassword() {
    char newPassword[PASSWORD_LENGTH];
    printf("비밀번호를 입력하세요 (4자리 정수): ");
    scanf("%s", newPassword);

    FILE *file = fopen("password.txt", "w");
    if (file == NULL) {
        printf("파일을 열 수 없습니다.\n");
        return;
    }

    fprintf(file, "%s", newPassword);
    fclose(file);
    printf("비밀번호가 설정되었습니다.\n");
}

void changePassword() {
    char currentPassword[PASSWORD_LENGTH], newPassword[PASSWORD_LENGTH];

    printf("현재 비밀번호를 입력하세요: ");
    scanf("%s", currentPassword);

    if (!checkPassword(currentPassword)) {
        printf("일치하지 않습니다.\n");
        return;
    }

    printf("새 비밀번호를 입력하세요 (4자리 정수): ");
    scanf("%s", newPassword);

    FILE *file = fopen("password.txt", "w");
    if (file == NULL) {
        printf("파일을 열 수 없습니다.\n");
        return;
    }

    fprintf(file, "%s", newPassword);
    fclose(file);
    printf("비밀번호가 변경되었습니다.\n");
}

int setting(){
	char choice;
    bool passwordExists = false;

    FILE *file = fopen("password.txt", "r");
    if (file != NULL) {
        fclose(file);
        passwordExists = true;
    }

    while (1) {
        if (!passwordExists) {
            printf("비밀번호를 설정하시겠습니까? (y/n): ");
            scanf(" %c", &choice);

            if (choice == 'y' || choice == 'Y') {
                setPassword();
            } else if (choice == 'n' || choice == 'N') {
                printf("처음으로 돌아갑니다..\n");
                break;
            }
            passwordExists = true;
        } else {
            printf("비밀번호를 변경하시겠습니까? (y/n): ");
            scanf(" %c", &choice);

            if (choice == 'y' || choice == 'Y') {
                changePassword();
            } else if (choice == 'n' || choice == 'N') {
                printf("처음으로 돌아갑니다..\n");
                break;
            }
        }
    }

}

int menu_ui(){
	char currentPassword[PASSWORD_LENGTH], newPassword[PASSWORD_LENGTH];
    system("cls");
    printf("        ┌─────────────────────────────────────┐\n");
	printf("        │                메뉴                 │\n");
    printf("        └─────────────────────────────────────┘\n");
    printf("        ┌─────────────────────────────────────┐\n");
    printf("        │              1. 일기                │\n");
    printf("        │              2. 플래너              │\n");
    printf("        │              3. 불러오기            │\n");
    printf("        │              4. 설정                │\n");
    printf("        │              5. 종료                │\n");
    printf("        └─────────────────────────────────────┘\n");
    
	int menu, day, view_select;
    printf("        ┌─────────────────────────────────────┐\n");
    printf("        │        입력 :                       │\n");
    printf("        └─────────────────────────────────────┘\n");
    GotoXY(24, 11);
	scanf("%d", &menu);
    system("cls");
	int month = 1, year = 2023;
    int monthf;
	switch (menu) {
        case 1:
            printf("        ┌─────────────────────────────────────┐\n");
            printf("        │              일기 메뉴              │\n");
            printf("        └─────────────────────────────────────┘\n");
            printf("        ┌─────────────────────────────────────┐\n");
            printf("        │       월을 입력하세요 :             │\n");
        	printf("        │       일를 입력하세요 :             │\n", MAX_DAYS_IN_MONTH);
            printf("        └─────────────────────────────────────┘\n");
            GotoXY(34, 4);
            scanf("%d", &monthf);
            GotoXY(34, 5);
        	scanf("%d", &day);
            system("cls");
            writeDiary(day, month);
            break;
        case 2:
            printf("        ┌─────────────────────────────────────┐\n");
            printf("        │             플래너 메뉴             │\n");
            printf("        └─────────────────────────────────────┘\n");
            printf("        ┌─────────────────────────────────────┐\n");
            printf("        │       월을 입력하세요 :             │\n");
            printf("        │       일를 입력하세요 :             │\n", MAX_DAYS_IN_MONTH);
            printf("        └─────────────────────────────────────┘\n");
            GotoXY(34, 4);
            scanf("%d", &monthf);
            GotoXY(34, 5);
        	scanf("%d", &day);
            system("cls");
            writePlanner(day, month);
            break;
        case 3:
            printf("        ┌─────────────────────────────────────┐\n");
            printf("        │             설정 메뉴               │\n");
            printf("        └─────────────────────────────────────┘\n");
            printf("        ┌─────────────────────────────────────┐\n");
        	printf("        │     비밀번호를 입력하세요:          │\n");      
            printf("        └─────────────────────────────────────┘\n");
            GotoXY(37, 4);
    		scanf("%s", currentPassword);
            system("cls");
        	if (!checkPassword(currentPassword)) {
		        printf("비밀번호가 일치하지 않습니다.\n");
                Sleep(2000);
		        break;
		    }
            
        	printCalendar(year, month);
        	printf("날짜를 선택하세요 : ", MAX_DAYS_IN_MONTH);
        	scanf("%d", &day);
        	printf("1. 일기 확인\n2. 플래너 확인\n==>");
			scanf("%d", &view_select);
			if(view_select == 1){
				viewDiary(day, month);
			}else if(view_select == 2){
				viewPlanner(day, month);
			}
            
            
            break;
        case 4:
            setting();
            break;
        case 5 :
        	printf("프로그램을 종료합니다.");
			exit(0);
        default:
            printf("잘못된 선택입니다. 다시 선택해주세요.\n");
    }
}

int main() {
    while(1){
    	menu_ui();
	}

    return 0;
}

